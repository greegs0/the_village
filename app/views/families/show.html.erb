<%= render 'shared/navbar' %>

<!-- SVG Definitions for gradient icons -->
<svg width="0" height="0" style="position: absolute;">
  <defs>
    <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea"/>
      <stop offset="100%" style="stop-color:#764ba2"/>
    </linearGradient>
  </defs>
</svg>

<!-- Main Content -->
<div class="container-fluid px-4 px-lg-5 py-4">
  <!-- Header -->
  <div class="mb-4">
    <h1 class="h2 mb-2 dashboard-title">Bienvenue dans votre Village</h1>
    <p class="text-secondary">Gérez votre famille et restez connectés</p>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 g-md-4 mb-4">
    <!-- Tâches en cours -->
    <div class="col-6 col-lg-3">
      <%= link_to family_tasks_path(@family), class: "text-decoration-none" do %>
        <div class="card stat-card rounded-4 h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <p class="text-secondary small mb-1">Tâches en cours</p>
              <h3 class="mb-0 stat-number"><%= @tasks.where(status: [false, nil]).count %></h3>
            </div>
            <div class="stat-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Événements cette semaine -->
    <div class="col-6 col-lg-3">
      <%= link_to family_family_events_path(@family), class: "text-decoration-none" do %>
        <div class="card stat-card rounded-4 h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <p class="text-secondary small mb-1">Événements cette semaine</p>
              <h3 class="mb-0 stat-number"><%= @events.count %></h3>
            </div>
            <div class="stat-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                <rect x="3" y="4" width="18" height="18" rx="2" stroke="url(#iconGradient)" stroke-width="1.5"></rect>
                <path d="M3 9h18" stroke="url(#iconGradient)" stroke-width="1.5"></path>
                <path d="M8 2v4" stroke="url(#iconGradient)" stroke-width="1.5" stroke-linecap="round"></path>
                <path d="M16 2v4" stroke="url(#iconGradient)" stroke-width="1.5" stroke-linecap="round"></path>
                <circle cx="8" cy="14" r="1.5" fill="url(#iconGradient)"></circle>
                <circle cx="12" cy="14" r="1.5" fill="url(#iconGradient)"></circle>
                <circle cx="16" cy="14" r="1.5" fill="url(#iconGradient)"></circle>
                <circle cx="8" cy="18" r="1.5" fill="url(#iconGradient)"></circle>
                <circle cx="12" cy="18" r="1.5" fill="url(#iconGradient)"></circle>
              </svg>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Membres actifs -->
    <div class="col-6 col-lg-3">
      <%= link_to new_person_path, class: "text-decoration-none" do %>
        <div class="card stat-card rounded-4 h-100" style="position: relative;">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <p class="text-secondary small mb-1">Membres actifs</p>
              <h3 class="mb-0 stat-number"><%= @people.count %></h3>
            </div>
            <div class="stat-icon" style="margin-top: -8px;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </div>
          </div>
          <div class="d-flex" style="position: absolute; bottom: 8px; right: 12px;">
            <% @people.first(5).each_with_index do |person, index| %>
              <div class="rounded-circle d-flex align-items-center justify-content-center"
                   style="width: 24px; height: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-left: <%= index == 0 ? '0' : '-6px' %>; border: 2px solid white;">
                <span class="text-white fw-medium" style="font-size: 9px;"><%= person.name.first.upcase %></span>
              </div>
            <% end %>
            <% if @people.count > 5 %>
              <div class="rounded-circle d-flex align-items-center justify-content-center"
                   style="width: 24px; height: 24px; background: #e5e7eb; margin-left: -6px; border: 2px solid white;">
                <span class="text-secondary fw-medium" style="font-size: 8px;">+<%= @people.count - 5 %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Documents partagés -->
    <div class="col-6 col-lg-3">
      <div class="card stat-card rounded-4 h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <p class="text-secondary small mb-1">Documents partagés</p>
            <h3 class="mb-0 stat-number">42</h3>
          </div>
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Village Assistant -->
  <div class="card border-0 rounded-4 mb-4 overflow-hidden shadow-sm">
    <div class="card-header village-assistant-header border-0 p-3">
      <div class="d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
          <%= image_tag "village-assistant-icon-v2.svg", alt: "Village Assistant", style: "width: 54px; height: 54px;" %>
        </div>
        <div>
          <h6 class="mb-0 text-white fw-medium">Village Assistant</h6>
          <small class="text-white opacity-75" style="font-size: 11px;">Toujours là pour vous aider</small>
        </div>
      </div>
    </div>
    <div class="card-body p-3 bg-white">
      <div class="d-flex mb-3">
        <div class="me-2">
          <div class="d-flex align-items-center justify-content-center" style="width: 28px; height: 28px;">
            <%= image_tag "village-assistant-avatar.svg", alt: "Assistant", style: "width: 28px; height: 28px;" %>
          </div>
        </div>
        <div class="flex-grow-1">
          <div class="rounded-3 p-2" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border: 1px solid rgba(102, 126, 234, 0.15);">
            <p class="mb-1" style="font-size: 13px; line-height: 1.4;">
              Bonjour ! Je suis l'assistant de The Village. Comment puis-je vous aider aujourd'hui ?
              Vous pouvez me demander de créer des tâches, planifier des événements, envoyer des messages à votre famille, ou obtenir des informations sur votre communauté.
            </p>
            <small class="text-muted" style="font-size: 11px;">09:28</small>
          </div>
        </div>
      </div>

      <!-- Input -->
      <div class="input-gradient-border">
        <div class="input-inner">
          <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control form-control-sm bg-transparent border-0 flex-grow-1"
                    placeholder="Posez une question à votre Village Assistant..."
                    style="font-size: 13px; padding: 6px 8px; color: #374151;">
            <button class="btn btn-sm rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 28px; height: 28px; padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4 mb-4">
    <!-- Upcoming Events -->
    <div class="col-lg-6">
      <div class="card stat-card rounded-4 h-100">
        <div class="card-body p-3 p-md-4">
          <h5 class="mb-1 dashboard-section-title">Événements à venir</h5>
          <p class="text-secondary small mb-4">Vos prochains rendez-vous et activités</p>

          <% if @events.any? %>
            <% @events.each do |event| %>
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 36px; height: 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  <span class="fw-medium text-white" style="font-size: 14px;"><%= event.assigned_to.present? ? event.assigned_to.first.upcase : event.title.first.upcase %></span>
                </div>
                <div class="flex-grow-1">
                  <p class="mb-0 small">
                    <% if event.assigned_to.present? %>
                      <strong><%= event.assigned_to %></strong> · <%= event.title %>
                    <% else %>
                      <strong><%= event.title %></strong>
                    <% end %>
                  </p>
                  <small class="text-muted">
                    <%= l(event.start_date, format: :long) %><% if event.time.present? %> à <%= event.time.strftime("%H:%M") %><% end %>
                    <% if event.location.present? %> · <%= event.location %><% end %>
                  </small>
                </div>
                <% if event.event_type.present? %>
                  <span class="badge rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 10px;">
                    <%= event.type_name %>
                  </span>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-center text-muted py-4">Aucun événement à venir pour le moment</p>
          <% end %>

          <%= link_to "Voir tout le calendrier", family_family_events_path(@family), class: "btn btn-primary w-100" %>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-6">
      <div class="card stat-card rounded-4 h-100">
        <div class="card-body p-3 p-md-4">
          <h5 class="mb-1 dashboard-section-title">Activité récente</h5>
          <p class="text-secondary small mb-4">Ce qui s'est passé dans votre village</p>

          <% if @recent_completed_tasks.any? %>
            <% @recent_completed_tasks.each do |task| %>
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 36px; height: 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  <span class="fw-medium text-white" style="font-size: 14px;"><%= task.assignee.name.first.upcase %></span>
                </div>
                <div class="flex-grow-1">
                  <p class="mb-0 small">
                    <strong><%= task.assignee.name %></strong> a complété la tâche
                    <%= link_to task.name, family_tasks_path(@family), class: "gradient-link" %>
                  </p>
                  <small class="text-muted"><%= time_ago_in_words(task.updated_at) %></small>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-center text-muted py-4">Aucune activité récente pour le moment</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Community Event Banner -->
  <div class="card stat-card rounded-4 mb-4">
    <div class="card-body p-3 p-md-4 d-flex flex-column flex-md-row align-items-center gap-3">
      <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="url(#iconGradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
      </div>
      <div class="flex-grow-1">
        <h5 class="mb-1 dashboard-section-title">Créer un événement de région</h5>
        <p class="text-secondary mb-0 small">
          Organisez un événement communautaire et invitez vos voisins ! Créez des liens avec votre quartier.
        </p>
      </div>
      <%= link_to "Découvrir les événements", events_path, class: "btn btn-primary" %>
    </div>
  </div>

  <!-- Task Progress Chart -->
  <div class="card stat-card rounded-4 mb-4">
    <div class="card-body p-3 p-md-4">
      <h5 class="mb-1 dashboard-section-title">Progression des tâches hebdomadaires</h5>
      <p class="text-secondary small mb-4">
        <% if @weekly_total > 0 %>
          Votre famille a complété <%= @weekly_percentage %>% des tâches cette semaine
        <% else %>
          Aucune tâche planifiée cette semaine
        <% end %>
      </p>

      <div class="row align-items-center mb-4">
        <div class="col-md-6">
          <div class="text-center mb-3">
            <div class="position-relative d-inline-block">
              <%
                circumference = 502
                completed_pct = @weekly_total > 0 ? (@weekly_completed.to_f / @weekly_total * 100).round : 0
                ongoing_pct = @weekly_total > 0 ? (@weekly_ongoing.to_f / @weekly_total * 100).round : 0
                overdue_pct = @weekly_total > 0 ? (@weekly_overdue.to_f / @weekly_total * 100).round : 0

                completed_length = (circumference * completed_pct / 100).round
                ongoing_length = (circumference * ongoing_pct / 100).round
                overdue_length = (circumference * overdue_pct / 100).round

                completed_offset = 0
                ongoing_offset = circumference - completed_length
                overdue_offset = circumference - completed_length - ongoing_length
              %>
              <svg width="180" height="180" viewBox="0 0 200 200">
                <defs>
                  <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#667eea"/>
                    <stop offset="100%" style="stop-color:#764ba2"/>
                  </linearGradient>
                </defs>
                <!-- Fond -->
                <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(102, 126, 234, 0.08)" stroke-width="16"/>
                <!-- En retard -->
                <% if overdue_pct > 0 %>
                  <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(102, 126, 234, 0.15)" stroke-width="16"
                          stroke-dasharray="<%= overdue_length %> <%= circumference - overdue_length %>"
                          stroke-dashoffset="<%= overdue_offset %>" transform="rotate(-90 100 100)"/>
                <% end %>
                <!-- En cours -->
                <% if ongoing_pct > 0 %>
                  <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(102, 126, 234, 0.4)" stroke-width="16"
                          stroke-dasharray="<%= ongoing_length %> <%= circumference - ongoing_length %>"
                          stroke-dashoffset="<%= ongoing_offset %>" transform="rotate(-90 100 100)"/>
                <% end %>
                <!-- Complétées -->
                <% if completed_pct > 0 %>
                  <circle cx="100" cy="100" r="80" fill="none" stroke="url(#progressGradient)" stroke-width="16"
                          stroke-dasharray="<%= completed_length %> <%= circumference - completed_length %>"
                          stroke-dashoffset="<%= completed_offset %>" transform="rotate(-90 100 100)" stroke-linecap="round"/>
                <% end %>
              </svg>
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="h2 mb-0 stat-number"><%= @weekly_percentage %>%</div>
                <small class="text-muted">Complétées</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <div class="d-flex align-items-center mb-3">
              <div class="rounded-circle" style="width: 14px; height: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
              <span class="ms-2 small"><strong><%= @weekly_completed %></strong> Complétées</span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <div class="rounded-circle" style="width: 14px; height: 14px; background: rgba(102, 126, 234, 0.4);"></div>
              <span class="ms-2 small"><strong><%= @weekly_ongoing %></strong> En cours</span>
            </div>
            <div class="d-flex align-items-center">
              <div class="rounded-circle" style="width: 14px; height: 14px; background: rgba(102, 126, 234, 0.15);"></div>
              <span class="ms-2 small"><strong><%= @weekly_overdue %></strong> En retard</span>
            </div>
          </div>
        </div>
      </div>

      <%= link_to "Gérer les tâches", family_tasks_path(@family), class: "btn btn-primary w-100" %>
    </div>
  </div>
</div>
