<%= render 'shared/navbar' %>

<!-- Main Content -->
<div class="container-fluid px-4 px-lg-5 py-4">
  <!-- Header -->
  <div class="mb-4">
    <h1 class="h2 mb-2 dashboard-title">Bienvenue dans votre Village</h1>
    <p class="text-secondary">G√©rez votre famille et restez connect√©s</p>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 g-md-4 mb-4">
    <!-- T√¢ches en cours -->
    <div class="col-6 col-lg-3">
      <%= link_to family_tasks_path(@family), class: "text-decoration-none" do %>
        <div class="card stat-card rounded-4 h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <p class="text-secondary small mb-1">T√¢ches en cours</p>
              <h3 class="mb-0 stat-number"><%= @tasks.where(status: [false, nil]).count %></h3>
            </div>
            <div class="text-primary fs-2">‚è≥</div>
          </div>
        </div>
      <% end %>
    </div>
    <!-- √âv√©nements cette semaine -->
    <div class="col-6 col-lg-3">
      <%= link_to family_family_events_path(@family), class: "text-decoration-none" do %>
        <div class="card stat-card rounded-4 h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <p class="text-secondary small mb-1">√âv√©nements cette semaine</p>
              <h3 class="mb-0 stat-number"><%= @events.count %></h3>
            </div>
            <div class="text-primary fs-2">üìÖ</div>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Membres actifs -->
    <div class="col-6 col-lg-3">
      <%= link_to new_person_path, class: "text-decoration-none" do %>
        <div class="card stat-card rounded-4 h-100" style="position: relative;">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <p class="text-secondary small mb-1">Membres actifs</p>
              <h3 class="mb-0 stat-number"><%= @people.count %></h3>
            </div>
            <div class="text-primary fs-2" style="margin-top: -8px;">üë•</div>
          </div>
          <div class="d-flex" style="position: absolute; bottom: 8px; right: 12px;">
            <% @people.first(5).each_with_index do |person, index| %>
              <div class="rounded-circle d-flex align-items-center justify-content-center"
                   style="width: 24px; height: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-left: <%= index == 0 ? '0' : '-6px' %>; border: 2px solid white;">
                <span class="text-white fw-medium" style="font-size: 9px;"><%= person.name.first.upcase %></span>
              </div>
            <% end %>
            <% if @people.count > 5 %>
              <div class="rounded-circle d-flex align-items-center justify-content-center"
                   style="width: 24px; height: 24px; background: #e5e7eb; margin-left: -6px; border: 2px solid white;">
                <span class="text-secondary fw-medium" style="font-size: 8px;">+<%= @people.count - 5 %></span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Documents partag√©s -->
    <div class="col-6 col-lg-3">
      <div class="card stat-card rounded-4 h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <p class="text-secondary small mb-1">Documents partag√©s</p>
            <h3 class="mb-0 stat-number">42</h3>
          </div>
          <div class="text-primary fs-2">üìÑ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Village Assistant Chat -->
  <div class="row g-4 mb-4">
    <!-- Main Chat Area (3/4) -->
    <div class="col-lg-9">
      <div class="card border-0 rounded-4 overflow-hidden shadow-sm">
        <div class="card-header village-assistant-header border-0 p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                <%= image_tag "village-assistant-icon-v2.svg", alt: "Village Assistant", style: "width: 54px; height: 54px;" %>
              </div>
              <div>
                <h6 class="mb-0 text-white fw-medium">Village Assistant</h6>
                <small class="text-white opacity-75" style="font-size: 11px;">Toujours l√† pour vous aider</small>
              </div>
            </div>
            <%= button_to chats_path, method: :post, params: { chat: { title: "Nouvelle conversation" } }, class: "btn btn-sm btn-light rounded-pill", form: { style: "display: inline;" } do %>
              ‚ûï Nouveau chat
            <% end %>
          </div>
        </div>
        <div class="card-body p-3 bg-white messages-container" id="messagesContainer" style="height: 400px; overflow-y: auto;">
          <% if @messages.any? %>
            <% @messages.each do |message| %>
              <div class="d-flex mb-3 <%= message.from_assistant? ? '' : 'justify-content-end' %>">
                <% if message.from_assistant? %>
                  <div class="me-2">
                    <div class="d-flex align-items-center justify-content-center" style="width: 28px; height: 28px;">
                      <%= image_tag "village-assistant-avatar.svg", alt: "Assistant", style: "width: 28px; height: 28px;" %>
                    </div>
                  </div>
                <% end %>
                <div class="flex-grow-1" style="max-width: 70%;">
                  <div class="rounded-3 p-2" style="<%= message.from_assistant? ? 'background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border: 1px solid rgba(102, 126, 234, 0.15);' : 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;' %>">
                    <p class="mb-1" style="font-size: 13px; line-height: 1.4;">
                      <%= message.content %>
                    </p>
                    <small class="<%= message.from_assistant? ? 'text-muted' : 'text-white opacity-75' %>" style="font-size: 11px;">
                      <%= l(message.created_at, format: :short) %>
                    </small>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="d-flex mb-3">
              <div class="me-2">
                <div class="d-flex align-items-center justify-content-center" style="width: 28px; height: 28px;">
                  <%= image_tag "village-assistant-avatar.svg", alt: "Assistant", style: "width: 28px; height: 28px;" %>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="rounded-3 p-2" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); border: 1px solid rgba(102, 126, 234, 0.15);">
                  <p class="mb-1" style="font-size: 13px; line-height: 1.4;">
                    Bonjour ! Je suis l'assistant de The Village. Comment puis-je vous aider aujourd'hui ?
                    Vous pouvez me demander de cr√©er des t√¢ches, planifier des √©v√©nements, envoyer des messages √† votre famille, ou obtenir des informations sur votre communaut√©.
                  </p>
                  <small class="text-muted" style="font-size: 11px;"><%= l(Time.current, format: :short) %></small>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Input -->
        <div class="card-footer bg-white border-0 p-3">
          <div class="input-gradient-border">
            <div class="input-inner">
              <%= form_with model: @message, url: chat_messages_path(@current_chat), method: :post, local: true, class: "d-flex align-items-center gap-2", id: "chatForm" do |f| %>
                <%= f.text_field :content, class: "form-control form-control-sm bg-transparent border-0 flex-grow-1", placeholder: "Posez une question √† votre Village Assistant...", style: "font-size: 13px; padding: 6px 8px; color: #374151;", id: "messageInput", autofocus: true %>
                <%= f.button type: "submit", class: "btn btn-sm rounded-circle d-flex align-items-center justify-content-center", style: "width: 28px; height: 28px; padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" do %>
                  <span style="font-size: 14px; color: white;">‚û§</span>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Sidebar (1/4) -->
    <div class="col-lg-3">
      <div class="card stat-card rounded-4 h-100">
        <div class="card-header bg-white border-0 p-3">
          <h6 class="mb-0 dashboard-section-title">Conversations</h6>
        </div>
        <div class="card-body p-2" style="max-height: 500px; overflow-y: auto;">
          <% if @chats.any? %>
            <% @chats.each do |chat| %>
              <%= link_to families_path(chat_id: chat.id), class: "text-decoration-none" do %>
                <div class="chat-item p-2 mb-1 rounded <%= chat.id == @current_chat.id ? 'chat-item-active' : '' %>">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <p class="mb-0 small fw-medium text-dark"><%= chat.title %></p>
                      <% if chat.last_message %>
                        <small class="text-muted" style="font-size: 11px;">
                          <%= truncate(chat.last_message.content, length: 30) %>
                        </small>
                      <% end %>
                    </div>
                    <small class="text-muted ms-2" style="font-size: 10px;">
                      <%= time_ago_in_words(chat.updated_at) %>
                    </small>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <p class="text-center text-muted small py-3">Aucune conversation</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4 mb-4">
    <!-- Upcoming Events -->
    <div class="col-lg-6">
      <div class="card stat-card rounded-4 h-100">
        <div class="card-body p-3 p-md-4">
          <h5 class="mb-1 dashboard-section-title">√âv√©nements √† venir</h5>
          <p class="text-secondary small mb-4">Vos prochains rendez-vous et activit√©s</p>

          <% if @events.any? %>
            <% @events.each do |event| %>
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle activity-avatar d-flex align-items-center justify-content-center me-3">
                  <span style="font-size: 16px;"><%= event.event_icon.present? ? event.event_icon : 'üìÖ' %></span>
                </div>
                <div class="flex-grow-1">
                  <p class="mb-0 small">
                    <strong><%= event.title %></strong>
                  </p>
                  <small class="text-muted">
                    <%= l(event.start_date, format: :long) %><% if event.time.present? %> √† <%= event.time.strftime("%H:%M") %><% end %>
                    <% if event.location.present? %> ¬∑ <%= event.location %><% end %>
                  </small>
                </div>
                <% if event.event_type.present? %>
                  <span class="badge rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 10px;">
                    <%= event.type_name %>
                  </span>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-center text-muted py-4">Aucun √©v√©nement √† venir pour le moment</p>
          <% end %>

          <%= link_to "Voir tout le calendrier", family_family_events_path(@family), class: "btn btn-primary w-100" %>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-6">
      <div class="card stat-card rounded-4 h-100">
        <div class="card-body p-3 p-md-4">
          <h5 class="mb-1 dashboard-section-title">Activit√© r√©cente</h5>
          <p class="text-secondary small mb-4">Ce qui s'est pass√© dans votre village</p>

          <% if @recent_completed_tasks.any? %>
            <% @recent_completed_tasks.each do |task| %>
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle activity-avatar d-flex align-items-center justify-content-center me-3">
                  <span class="fw-medium"><%= task.assignee.name.first.upcase %></span>
                </div>
                <div class="flex-grow-1">
                  <p class="mb-0 small">
                    <strong><%= task.assignee.name %></strong> a compl√©t√© la t√¢che
                    <%= link_to task.name, family_tasks_path(@family), class: "gradient-link" %>
                  </p>
                  <small class="text-muted"><%= time_ago_in_words(task.updated_at) %></small>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-center text-muted py-4">Aucune activit√© r√©cente pour le moment</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Community Event Banner -->
  <div class="card stat-card rounded-4 mb-4">
    <div class="card-body p-3 p-md-4 d-flex flex-column flex-md-row align-items-center gap-3">
      <div class="fs-1">üåç</div>
      <div class="flex-grow-1">
        <h5 class="mb-1 dashboard-section-title">Cr√©er un √©v√©nement de r√©gion</h5>
        <p class="text-secondary mb-0 small">
          Organisez un √©v√©nement communautaire et invitez vos voisins ! Cr√©ez des liens avec votre quartier.
        </p>
      </div>
      <%= link_to "D√©couvrir les √©v√©nements", events_path, class: "btn btn-primary" %>
    </div>
  </div>

  <!-- Task Progress Chart -->
  <div class="card stat-card rounded-4 mb-4">
    <div class="card-body p-3 p-md-4">
      <h5 class="mb-1 dashboard-section-title">Progression des t√¢ches hebdomadaires</h5>
      <p class="text-secondary small mb-4">
        <% if @weekly_total > 0 %>
          Votre famille a compl√©t√© <%= @weekly_percentage %>% des t√¢ches cette semaine
        <% else %>
          Aucune t√¢che planifi√©e cette semaine
        <% end %>
      </p>

      <div class="row align-items-center mb-4">
        <div class="col-md-6">
          <div class="text-center mb-3">
            <div class="position-relative d-inline-block">
              <%
                circumference = 502
                completed_pct = @weekly_total > 0 ? (@weekly_completed.to_f / @weekly_total * 100).round : 0
                ongoing_pct = @weekly_total > 0 ? (@weekly_ongoing.to_f / @weekly_total * 100).round : 0
                overdue_pct = @weekly_total > 0 ? (@weekly_overdue.to_f / @weekly_total * 100).round : 0

                completed_length = (circumference * completed_pct / 100).round
                ongoing_length = (circumference * ongoing_pct / 100).round
                overdue_length = (circumference * overdue_pct / 100).round

                completed_offset = 0
                ongoing_offset = circumference - completed_length
                overdue_offset = circumference - completed_length - ongoing_length
              %>
              <svg width="180" height="180" viewBox="0 0 200 200">
                <defs>
                  <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#667eea"/>
                    <stop offset="100%" style="stop-color:#764ba2"/>
                  </linearGradient>
                </defs>
                <!-- Fond -->
                <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(102, 126, 234, 0.08)" stroke-width="16"/>
                <!-- En retard -->
                <% if overdue_pct > 0 %>
                  <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(102, 126, 234, 0.15)" stroke-width="16"
                          stroke-dasharray="<%= overdue_length %> <%= circumference - overdue_length %>"
                          stroke-dashoffset="<%= overdue_offset %>" transform="rotate(-90 100 100)"/>
                <% end %>
                <!-- En cours -->
                <% if ongoing_pct > 0 %>
                  <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(102, 126, 234, 0.4)" stroke-width="16"
                          stroke-dasharray="<%= ongoing_length %> <%= circumference - ongoing_length %>"
                          stroke-dashoffset="<%= ongoing_offset %>" transform="rotate(-90 100 100)"/>
                <% end %>
                <!-- Compl√©t√©es -->
                <% if completed_pct > 0 %>
                  <circle cx="100" cy="100" r="80" fill="none" stroke="url(#progressGradient)" stroke-width="16"
                          stroke-dasharray="<%= completed_length %> <%= circumference - completed_length %>"
                          stroke-dashoffset="<%= completed_offset %>" transform="rotate(-90 100 100)" stroke-linecap="round"/>
                <% end %>
              </svg>
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="h2 mb-0 stat-number"><%= @weekly_percentage %>%</div>
                <small class="text-muted">Compl√©t√©es</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <div class="d-flex align-items-center mb-3">
              <div class="rounded-circle" style="width: 14px; height: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
              <span class="ms-2 small"><strong><%= @weekly_completed %></strong> Compl√©t√©es</span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <div class="rounded-circle" style="width: 14px; height: 14px; background: rgba(102, 126, 234, 0.4);"></div>
              <span class="ms-2 small"><strong><%= @weekly_ongoing %></strong> En cours</span>
            </div>
            <div class="d-flex align-items-center">
              <div class="rounded-circle" style="width: 14px; height: 14px; background: rgba(102, 126, 234, 0.15);"></div>
              <span class="ms-2 small"><strong><%= @weekly_overdue %></strong> En retard</span>
            </div>
          </div>
        </div>
      </div>

      <%= link_to "G√©rer les t√¢ches", family_tasks_path(@family), class: "btn btn-primary w-100" %>
    </div>
  </div>
</div>

<script>
  // Auto-scroll vers le bas des messages au chargement de la page
  document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Focus automatique sur l'input
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
      messageInput.focus();
    }
  });

  // Raccourci clavier: Enter pour envoyer, Shift+Enter pour nouvelle ligne
  const messageInput = document.getElementById('messageInput');
  if (messageInput) {
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const form = document.getElementById('chatForm');
        if (form && messageInput.value.trim() !== '') {
          form.requestSubmit();
        }
      }
    });
  }
</script>
