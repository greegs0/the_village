<%= render 'shared/navbar' %>

<!-- Main Content -->
<div class="container-fluid px-4 px-lg-5 py-4">
  <!-- Header -->
  <div class="mb-4">
    <h1 class="h2 mb-2">Bienvenue dans votre Village</h1>
    <p class="text-secondary">Voici un aper√ßu de votre journ√©e</p>
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 g-md-4 mb-4">
    <div class="col-6 col-lg-3">
      <%= link_to family_tasks_path(@family), class: "text-decoration-none" do %>
        <div class="card border rounded-4 h-100">
          <div class="card-body p-3 p-md-4 d-flex justify-content-between align-items-center">
            <div>
              <p class="text-secondary small mb-1">T√¢ches en cours</p>
              <h3 class="h2 mb-0 text-dark"><%= @tasks.where(status: [false, nil]).count %></h3>
            </div>
            <div class="text-primary fs-1">‚è≥</div>
          </div>
        </div>
      <% end %>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card border rounded-4 h-100">
        <div class="card-body p-3 p-md-4 d-flex justify-content-between align-items-center">
          <div>
            <p class="text-secondary small mb-1">√âv√©nements cette semaine</p>
            <h3 class="h2 mb-0"><%= @events.count %></h3>
          </div>
          <div class="text-primary fs-1">üìÖ</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card border rounded-4 h-100">
        <div class="card-body p-3 p-md-4 d-flex justify-content-between align-items-center">
          <div>
            <p class="text-secondary small mb-1">Membres actifs</p>
            <h3 class="h2 mb-0"><%= Person.count %></h3>
          </div>
          <div class="text-primary fs-1">üë•</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="card border rounded-4 h-100">
        <div class="card-body p-3 p-md-4 d-flex justify-content-between align-items-center">
          <div>
            <p class="text-secondary small mb-1">Documents partag√©s</p>
            <h3 class="h2 mb-0">42</h3>
          </div>
          <div class="text-primary fs-1">üìÑ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Village Assistant Chat -->
  <div class="row g-4 mb-4">
    <!-- Main Chat Area (3/4) -->
    <div class="col-lg-9">
      <div class="card border-0 rounded-4 overflow-hidden shadow-sm">
        <div class="card-header border-0 p-3" style="background: linear-gradient(90deg, #6366f1 0%, #a855f7 50%, #f97316 100%);">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                <span style="font-size: 18px;">üèòÔ∏è</span>
              </div>
              <div>
                <h6 class="mb-0 text-white fw-medium">Village Assistant</h6>
                <small class="text-white opacity-75" style="font-size: 11px;">Toujours l√† pour vous aider</small>
              </div>
            </div>
            <%= form_with model: Chat.new, url: chats_path, method: :post, local: true, class: "d-inline" do |f| %>
              <%= f.hidden_field :title, value: "Nouvelle conversation" %>
              <%= f.submit "‚ûï Nouveau chat", class: "btn btn-sm btn-light", style: "font-size: 11px;" %>
            <% end %>
          </div>
        </div>

        <div class="card-body p-3 bg-white" style="min-height: 400px; max-height: 500px; overflow-y: auto;" id="chat-messages">
          <% if @messages.any? %>
            <% @messages.each do |message| %>
              <div class="d-flex mb-3 <%= 'justify-content-end' if message.from_user? %>">
                <% if message.from_assistant? %>
                  <div class="me-2">
                    <div class="rounded-circle d-flex align-items-center justify-content-center"
                          style="width: 28px; height: 28px; background: linear-gradient(135deg, #a855f7 0%, #f97316 100%);">
                      <span style="font-size: 14px;">üèòÔ∏è</span>
                    </div>
                  </div>
                <% end %>

                <div class="<%= message.from_user? ? 'text-end' : 'flex-grow-1' %>" style="max-width: 75%;">
                  <div class="<%= message.from_user? ? 'bg-primary text-white' : 'bg-light' %> rounded-3 p-2">
                    <p class="mb-1" style="font-size: 13px; line-height: 1.4;">
                      <%= message.content %>
                    </p>
                    <small class="<%= message.from_user? ? 'text-white opacity-75' : 'text-muted' %>" style="font-size: 11px;">
                      <%= message.created_at.strftime("%H:%M") %>
                    </small>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center text-muted py-5">
              <span style="font-size: 48px;">üèòÔ∏è</span>
              <p class="mt-3">Bonjour ! Je suis l'assistant de The Village.</p>
              <p class="small">Comment puis-je vous aider aujourd'hui ?</p>
            </div>
          <% end %>
        </div>

        <!-- Message Input -->
        <%= form_with model: @message, url: chat_messages_path(@current_chat), method: :post, local: true do |f| %>
          <div class="card-footer border-0 p-3 bg-white">
            <div class="rounded-3 p-2" style="background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%);">
              <div class="d-flex align-items-center gap-1">
                <%= f.text_area :content,
                    rows: 1,
                    class: "form-control form-control-sm bg-transparent border-0 text-white",
                    placeholder: "Demandez √† Village de vous aider...",
                    style: "font-size: 13px; padding: 6px 8px; resize: none;",
                    required: true %>
                <%= f.submit "‚û§",
                    class: "btn btn-sm btn-primary rounded-circle d-flex align-items-center justify-content-center",
                    style: "width: 32px; height: 32px; padding: 0; font-size: 14px;" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Chat History Sidebar (1/4) -->
    <div class="col-lg-3">
      <div class="card border rounded-4 h-100">
        <div class="card-body p-3">
          <h6 class="mb-3">Mes conversations</h6>

          <% if @chats.any? %>
            <div class="list-group list-group-flush">
              <% @chats.each do |chat| %>
                <%= link_to families_path(chat_id: chat.id),
                    class: "list-group-item list-group-item-action border-0 rounded-3 mb-2 #{'active' if chat.id == @current_chat.id}",
                    style: "font-size: 13px; padding: 10px;" do %>
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-medium mb-1">
                        <%= chat.title.presence || "Conversation sans titre" %>
                      </div>
                      <% if chat.last_message %>
                        <small class="text-muted d-block text-truncate" style="max-width: 150px;">
                          <%= chat.last_message.content.truncate(30) %>
                        </small>
                      <% end %>
                    </div>
                    <small class="text-muted" style="font-size: 10px;">
                      <%= time_ago_in_words(chat.updated_at) %>
                    </small>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% else %>
            <p class="text-center text-muted small py-3">Aucune conversation</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="row g-4 mb-4">
    <!-- Upcoming Events -->
    <div class="col-lg-6">
      <div class="card border rounded-4 h-100">
        <div class="card-body p-3 p-md-4">
          <h5 class="mb-1">√âv√©nements √† venir</h5>
          <p class="text-secondary small mb-4">Vos prochains rendez-vous et activit√©s</p>

          <% if @events.any? %>
            <% @events.each do |event| %>
              <div class="d-flex justify-content-between align-items-start bg-light rounded-3 p-3 mb-3">
                <div class="flex-grow-1">
                  <h6 class="mb-1">
                    <% if event.event_icon.present? %>
                      <span class="me-1"><%= event.event_icon %></span>
                    <% end %>
                    <%= event.title %>
                  </h6>
                  <p class="text-secondary small mb-0">
                    <span class="me-2">üïê</span>
                    <%= l(event.start_date, format: :long) %>
                    <% if event.time.present? %>
                      , <%= event.time.strftime("%H:%M") %>
                    <% end %>
                  </p>
                  <% if event.location.present? %>
                    <p class="text-secondary small mb-0">
                      <span class="me-2">üìç</span><%= event.location %>
                    </p>
                  <% end %>
                </div>
                <% if event.event_type.present? %>
                  <span class="badge text-white" style="background-color: <%= event.event_color %>;">
                    <%= event.type_name %>
                  </span>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-center text-muted py-4">Aucun √©v√©nement √† venir pour le moment</p>
          <% end %>

          <%= link_to "Voir tout le calendrier", family_family_events_path(@family), class: "btn btn-outline-secondary w-100" %>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-6">
      <div class="card border rounded-4 h-100">
        <div class="card-body p-3 p-md-4">
          <h5 class="mb-1">Activit√© r√©cente</h5>
          <p class="text-secondary small mb-4">Ce qui s'est pass√© dans votre village</p>

          <% if @recent_completed_tasks.any? %>
            <% @recent_completed_tasks.each do |task| %>
              <div class="d-flex mb-3">
                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3"
                      style="width: 40px; height: 40px;">
                  <span class="fw-medium"><%= task.assignee.name.first.upcase %></span>
                </div>
                <div class="flex-grow-1">
                  <p class="mb-1 small">
                    <strong><%= task.assignee.name %></strong> a compl√©t√© la t√¢che
                    <%= link_to task.name, family_tasks_path(@family), class: "text-primary text-decoration-none" %>
                  </p>
                  <small class="text-muted"><%= time_ago_in_words(task.updated_at) %></small>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-center text-muted py-4">Aucune activit√© r√©cente pour le moment</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Community Event Banner -->
  <div class="card border rounded-4 mb-4 bg-gradient-light">
    <div class="card-body p-3 p-md-4 d-flex flex-column flex-md-row align-items-center gap-3">
      <div class="fs-1">üåç</div>
      <div class="flex-grow-1">
        <h5 class="mb-1">Cr√©er un √©v√©nement de r√©gion</h5>
        <p class="text-secondary mb-0 small">
          Organisez un √©v√©nement communautaire et invitez vos voisins ! Cr√©ez des liens avec votre quartier.
        </p>
      </div>
      <%= link_to "D√©couvrir les √©v√©nements", events_path, class: "btn btn-primary" %>
    </div>
  </div>

  <!-- Task Progress Chart -->
  <div class="card border rounded-4 mb-4">
    <div class="card-body p-3 p-md-4">
      <h5 class="mb-1">Progression des t√¢ches hebdomadaires</h5>
      <p class="text-secondary small mb-4">
        <% if @weekly_total > 0 %>
          Votre famille a compl√©t√© <%= @weekly_percentage %>% des t√¢ches cette semaine
        <% else %>
          Aucune t√¢che planifi√©e cette semaine
        <% end %>
      </p>

      <div class="row align-items-center mb-4">
        <div class="col-md-6">
          <div class="text-center mb-3">
            <div class="position-relative d-inline-block">
              <% stroke_offset = @weekly_total > 0 ? (502 * (100 - @weekly_percentage) / 100).round : 502 %>
              <svg width="200" height="200" viewBox="0 0 200 200">
                <circle cx="100" cy="100" r="80" fill="none" stroke="#e5e7eb" stroke-width="20"/>
                <circle cx="100" cy="100" r="80" fill="none" stroke="#10b981" stroke-width="20"
                        stroke-dasharray="502" stroke-dashoffset="<%= stroke_offset %>" transform="rotate(-90 100 100)"/>
              </svg>
              <div class="position-absolute top-50 start-50 translate-middle text-center">
                <div class="h2 mb-0"><%= @weekly_percentage %>%</div>
                <small class="text-muted">Compl√©t√©es</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <div class="rounded" style="width: 12px; height: 12px; background-color: #10b981;"></div>
              <span class="ms-2 small">Compl√©t√©es: <%= @weekly_completed %></span>
            </div>
            <div class="d-flex align-items-center mb-2">
              <div class="rounded" style="width: 12px; height: 12px; background-color: #f59e0b;"></div>
              <span class="ms-2 small">En cours: <%= @weekly_ongoing %></span>
            </div>
            <div class="d-flex align-items-center">
              <div class="rounded" style="width: 12px; height: 12px; background-color: #ef4444;"></div>
              <span class="ms-2 small">En retard: <%= @weekly_overdue %></span>
            </div>
          </div>
        </div>
      </div>

      <%= link_to "G√©rer les t√¢ches", family_tasks_path(@family), class: "btn btn-dark w-100" %>
    </div>
  </div>
</div>
