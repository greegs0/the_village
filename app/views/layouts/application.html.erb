<!DOCTYPE html>
<html>
  <head>
    <title>The Village - Gestion familiale & communautaire</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="The Village - Application de gestion familiale et communautaire pour organiser vos tâches, événements et documents.">

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3CradialGradient id='bgGrad' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' style='stop-color:%23ffffff;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23f3f4f6;stop-opacity:1'/%3E%3C/radialGradient%3E%3ClinearGradient id='houseGrad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='100' cy='100' r='95' fill='url(%23bgGrad)'/%3E%3Cg transform='translate(50,40)'%3E%3Cpath d='M 20 40 L 50 15 L 80 40 L 80 85 L 20 85 Z' fill='url(%23houseGrad)' stroke='%234F46E5' stroke-width='3'/%3E%3Crect x='38' y='60' width='24' height='25' fill='%23ffffff' opacity='0.9' rx='2'/%3E%3Ccircle cx='40' cy='35' r='5' fill='%23ffffff' opacity='0.95'/%3E%3Ccircle cx='60' cy='35' r='5' fill='%23ffffff' opacity='0.95'/%3E%3Cpath d='M 0 55 L 20 40 L 40 55 L 40 85 L 0 85 Z' fill='%23667eea' opacity='0.85'/%3E%3Crect x='12' y='68' width='16' height='17' fill='%23ffffff' opacity='0.8' rx='1'/%3E%3Cpath d='M 60 55 L 80 40 L 100 55 L 100 85 L 60 85 Z' fill='%23764ba2' opacity='0.85'/%3E%3Crect x='72' y='68' width='16' height='17' fill='%23ffffff' opacity='0.8' rx='1'/%3E%3Ccircle cx='10' cy='90' r='6' fill='%2310b981' opacity='0.7'/%3E%3Crect x='9' y='90' width='2' height='10' fill='%23059669'/%3E%3Ccircle cx='90' cy='90' r='6' fill='%2310b981' opacity='0.7'/%3E%3Crect x='89' y='90' width='2' height='10' fill='%23059669'/%3E%3C/g%3E%3C/svg%3E">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="The Village - Gestion familiale & communautaire">
    <meta property="og:description" content="Application de gestion familiale et communautaire">
    <meta property="og:image" content="<%= asset_url('the-village-logo.svg') %>">
    <meta property="og:type" content="website">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="<%= 'with-sidebar' unless action_name == 'home' %>">
    <%= render "shared/village_alert" %>

    <% unless action_name == "home" %>
      <!-- Mobile navbar (fixed top with logo + hamburger) -->
      <div class="mobile-navbar">
        <%= link_to families_path, class: "mobile-navbar-brand" do %>
          <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" class="mobile-logo-svg">
            <defs>
              <linearGradient id="mobileGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
              </linearGradient>
            </defs>
            <g transform="translate(25, 25)">
              <path d="M 15 30 L 35 12 L 55 30 L 55 60 L 15 60 Z" fill="url(#mobileGrad)" stroke="#5568D3" stroke-width="2.5"/>
              <rect x="28" y="42" width="14" height="18" fill="#ffffff" opacity="0.95" rx="1"/>
              <circle cx="28" cy="26" r="3" fill="#ffffff" opacity="0.98"/>
              <circle cx="42" cy="26" r="3" fill="#ffffff" opacity="0.98"/>
              <path d="M 0 42 L 15 30 L 30 42 L 30 60 L 0 60 Z" fill="#667eea" opacity="0.85"/>
              <rect x="10" y="50" width="10" height="10" fill="#ffffff" opacity="0.8" rx="0.5"/>
              <path d="M 40 42 L 55 30 L 70 42 L 70 60 L 40 60 Z" fill="#764ba2" opacity="0.85"/>
              <rect x="52" y="50" width="10" height="10" fill="#ffffff" opacity="0.8" rx="0.5"/>
            </g>
          </svg>
          <span class="mobile-brand-text">The Village</span>
        <% end %>

        <button class="mobile-hamburger" data-action="click->sidebar#toggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- App pages: Show sidebar -->
      <%= render 'shared/sidebar' %>

      <!-- Mobile overlay -->
      <div class="sidebar-overlay" data-action="click->sidebar#closeFromOverlay"></div>
    <% end %>

    <!-- Main content wrapper -->
    <div class="<%= 'main-content-wrapper' unless action_name == 'home' %>">
      <%= yield %>
    </div>

    <%= render "shared/chat_widget" %>

    <!-- Nettoyage modals pour Turbo -->
    <script>
      (function() {
        if (window._turboModalCleanup) return;
        window._turboModalCleanup = true;
        document.addEventListener('turbo:before-cache', function() {
          document.querySelectorAll('.modal.show').forEach(function(m) {
            var inst = bootstrap.Modal.getInstance(m);
            if (inst) inst.hide();
          });
          document.querySelectorAll('.modal-backdrop').forEach(function(b) { b.remove(); });
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
        });
      })();
    </script>

    <!-- Village Confirm - Remplace les confirmations Turbo natives -->
    <script>
      document.addEventListener('turbo:load', function() {
        if (window.Turbo && !window._villageConfirmSetup) {
          window._villageConfirmSetup = true;

          Turbo.setConfirmMethod(function(message) {
            return new Promise(function(resolve) {
              if (window.VillageAlert) {
                window.VillageAlert.confirm(message, {
                  danger: true,
                  confirmText: "Supprimer",
                  cancelText: "Annuler",
                  onConfirm: function() {
                    resolve(true);
                  },
                  onCancel: function() {
                    resolve(false);
                  }
                });
              } else {
                resolve(confirm(message));
              }
            });
          });
        }
      }, { once: true });

      // Aussi sur DOMContentLoaded au cas où
      document.addEventListener('DOMContentLoaded', function() {
        if (window.Turbo && !window._villageConfirmSetup) {
          window._villageConfirmSetup = true;

          Turbo.setConfirmMethod(function(message) {
            return new Promise(function(resolve) {
              if (window.VillageAlert) {
                window.VillageAlert.confirm(message, {
                  danger: true,
                  confirmText: "Supprimer",
                  cancelText: "Annuler",
                  onConfirm: function() {
                    resolve(true);
                  },
                  onCancel: function() {
                    resolve(false);
                  }
                });
              } else {
                resolve(confirm(message));
              }
            });
          });
        }
      }, { once: true });
    </script>

    <%# Afficher les flash messages via Village Alert %>
    <% flash.each do |type, message| %>
      <% next if message.blank? %>
      <% alert_type = (type.to_s == 'notice' || type.to_s == 'success') ? 'success' : 'error' %>
      <% flash_id = "flash_#{Time.now.to_i}_#{rand(10000)}" %>
      <script data-flash-id="<%= flash_id %>">
        (function() {
          var flashId = '<%= flash_id %>';
          // Vérifier si ce flash a déjà été affiché
          if (!window._shownFlashes) window._shownFlashes = {};
          if (window._shownFlashes[flashId]) return;
          window._shownFlashes[flashId] = true;

          function showAlert() {
            if (window.VillageAlert) {
              window.VillageAlert.<%= alert_type %>("<%= j message.to_s %>");
            }
            // Supprimer le script après exécution pour éviter le cache Turbo
            var script = document.querySelector('script[data-flash-id="' + flashId + '"]');
            if (script) script.remove();
          }
          // Essayer immédiatement
          if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(showAlert, 100);
          } else {
            document.addEventListener('DOMContentLoaded', showAlert, { once: true });
          }
        })();
      </script>
    <% end %>

  </body>
</html>
