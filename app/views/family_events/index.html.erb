  <!-- Main Content -->
  <div class="container-fluid px-4 px-lg-5 py-4">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
      <div>
        <h1 class="h2 mb-2">Calendrier Familial</h1>
        <p class="text-secondary mb-0">Organisez les gardes, anniversaires et √©v√©nements</p>
      </div>
      <div class="d-flex gap-2">
        <%# <button class="btn btn-outline-secondary">
          <span class="me-2">üì§</span>Exporter
        </button> %>
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#newEventModal">
          <span class="me-2">+</span>Nouvel √©v√©nement
        </button>
      </div>
    </div>

    <%# <!-- Tabs -->
    <ul class="nav nav-pills bg-light rounded-3 p-1 mb-4" role="tablist">
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link active w-100" data-bs-toggle="pill" data-bs-target="#month" type="button">
          Vue mensuelle
        </button>
      </li> %>
      <%#<li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#week" type="button">
          Semaine
        </button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" data-bs-toggle="pill" data-bs-target="#list" type="button">
          Liste
        </button>
      </li>%>
    <%# </ul> %>

    <!-- Tab Content -->
    <div class="tab-content">
      <div class="tab-pane fade show active" id="month">
        <%# <!-- Google Calendar Integration -->
        <div class="card border rounded-4 mb-4" style="background: linear-gradient(135deg, rgba(239, 246, 255, 1) 0%, rgba(250, 245, 255, 1) 100%);">
          <div class="card-body p-4 d-flex flex-column flex-md-row align-items-center gap-3">
            <div class="fs-1">üìÖ</div>
            <div class="flex-grow-1">
              <h5 class="mb-1">Connectez votre Google Calendar</h5>
              <p class="text-secondary mb-0 small">
                Importez automatiquement vos rendez-vous et gardez tout synchronis√© en temps r√©el.
              </p>
            </div>
            <button class="btn btn-outline-dark">
              <span class="me-2">üîó</span>Connecter Google Calendar
            </button>
          </div>
        </div> %>

        <!-- Calendar -->
        <div class="card border rounded-4 mb-4">
          <div class="card-body p-3 p-md-4">
            <!-- Calendar Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-2">
                <%= link_to "‚óÄ", family_family_events_path(@family, date: (@current_date - 1.month).to_s), class: "btn btn-sm btn-outline-secondary" %>
                <h5 class="mb-0"><%= I18n.l(@current_date, format: :month_and_year) %></h5>
                <%= link_to "‚ñ∂", family_family_events_path(@family, date: (@current_date + 1.month).to_s), class: "btn btn-sm btn-outline-secondary" %>
              </div>
              <%= link_to "Aujourd'hui", family_family_events_path(@family), class: "btn btn-sm btn-outline-secondary" %>
            </div>

            <!-- Calendar Grid -->
            <div class="table-responsive">
              <table class="table table-bordered text-center">
                <thead>
                  <tr>
                    <th class="bg-light">Lun</th>
                    <th class="bg-light">Mar</th>
                    <th class="bg-light">Mer</th>
                    <th class="bg-light">Jeu</th>
                    <th class="bg-light">Ven</th>
                    <th class="bg-light">Sam</th>
                    <th class="bg-light">Dim</th>
                  </tr>
                </thead>
                <tbody>
                  <% @calendar_weeks.each do |week| %>
                    <tr>
                      <% week.each do |day| %>
                        <%
                          is_today = day == Date.today
                          is_weekend = day.saturday? || day.sunday?
                          is_current_month = day.month == @current_date.month
                          # Select events that occur on this day (including multi-day events)
                          day_events = @family_events.select do |e|
                            event_end = e.end_date || e.start_date
                            day >= e.start_date && day <= event_end
                          end
                        %>
                        <td class="p-2 <%= 'bg-light' if is_weekend %> <%= 'bg-primary bg-opacity-10' if is_today %>" style="width: 14.28%; height: 120px; min-height: 120px; max-height: 120px; min-width: 120px; vertical-align: top; overflow: hidden;">
                          <div class="fw-medium text-center <%= 'text-primary' if is_today %> <%= 'text-muted' unless is_current_month %>">
                            <%= day.day %>
                          </div>
                          <div style="max-height: 90px; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; align-items: center;">
                            <% day_events.each do |event| %>
                              <div class="badge text-white small mb-1"
                                   style="cursor: pointer; background-color: <%= event.event_color %>; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%;"
                                   data-bs-toggle="modal"
                                   data-bs-target="#eventDetailsModal"
                                   data-event-id="<%= event.id %>"
                                   data-event-title="<%= event.title %>"
                                   data-event-type="<%= event.type_name %>"
                                   data-event-type-value="<%= event.event_type %>"
                                   data-event-date="<%= event.formatted_date %>"
                                   data-event-start-date="<%= event.start_date %>"
                                   data-event-time="<%= event.formatted_time %>"
                                   data-event-time-value="<%= event.time&.strftime('%H:%M') %>"
                                   data-event-location="<%= event.location %>"
                                   data-event-description="<%= event.description %>"
                                   data-event-assigned="<%= event.assigned_to %>"
                                   data-event-icon="<%= event.event_icon %>"
                                   data-event-badge="<%= event.badge_class %>"
                                   data-event-reminders="<%= event.reminders_enabled %>">
                                <%= event.title %>
                              </div>
                            <% end %>
                          </div>
                        </td>
                      <% end %>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Unavailability Section -->
        <div class="card border rounded-4 mb-4">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-1">
                  <span class="me-2">üö´</span>Indisponibilit√©s
                </h5>
                <p class="text-secondary small mb-0">Bloquez des dates o√π vous n'√™tes pas disponible</p>
              </div>
              <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#unavailabilityModal">
                <span class="me-2">+</span>Ajouter
              </button>
            </div>

            <div class="d-flex flex-column gap-3">
              <% unavailabilities = @family_events.select { |e| e.event_type == 'indisponibilite' } %>
              <% if unavailabilities.any? %>
                <% unavailabilities.each do |unavail| %>
                  <div class="d-flex justify-content-between align-items-center bg-light rounded-3 p-3">
                    <div class="d-flex align-items-center gap-3">
                      <div class="rounded-circle bg-secondary bg-opacity-25 d-flex align-items-center justify-content-center"
                           style="width: 40px; height: 40px;">
                        <span class="fw-medium"><%= unavail.assigned_to&.first&.upcase || '?' %></span>
                      </div>
                      <div>
                        <div class="fw-medium"><%= unavail.assigned_to || 'Non assign√©' %> <span class="text-secondary">indisponible</span></div>
                        <small class="text-secondary"><%= unavail.formatted_date %></small>
                        <% if unavail.description.present? %>
                          <div class="small text-muted"><%= unavail.description %></div>
                        <% end %>
                      </div>
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-link"
                              data-bs-toggle="modal"
                              data-bs-target="#eventDetailsModal"
                              data-event-id="<%= unavail.id %>"
                              data-event-title="<%= unavail.title %>"
                              data-event-type="<%= unavail.type_name %>"
                              data-event-type-value="<%= unavail.event_type %>"
                              data-event-date="<%= unavail.formatted_date %>"
                              data-event-start-date="<%= unavail.start_date %>"
                              data-event-time="<%= unavail.formatted_time %>"
                              data-event-time-value="<%= unavail.time&.strftime('%H:%M') %>"
                              data-event-location="<%= unavail.location %>"
                              data-event-description="<%= unavail.description %>"
                              data-event-assigned="<%= unavail.assigned_to %>"
                              data-event-icon="<%= unavail.event_icon %>"
                              data-event-badge="<%= unavail.badge_class %>"
                              data-event-reminders="<%= unavail.reminders_enabled %>">
                        ‚úèÔ∏è
                      </button>
                    </div>
                  </div>
                <% end %>
              <% else %>
                <div class="text-center text-muted py-3">
                  <p class="mb-0">Aucune indisponibilit√© pour le moment</p>
                  <small>Cliquez sur "Ajouter" pour bloquer une p√©riode</small>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Legend and Upcoming Events -->
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card border rounded-4 h-100">
              <div class="card-body p-4">
                <h5 class="mb-1">L√©gende</h5>
                <p class="text-secondary small mb-4">Types d'√©v√©nements</p>

                <div class="d-flex flex-column gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded" style="width: 16px; height: 16px; background-color: #f6339a;"></div>
                    <span class="small">Anniversaire</span>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded" style="width: 16px; height: 16px; background-color: #2b7fff;"></div>
                    <span class="small">Garde d'enfant</span>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded" style="width: 16px; height: 16px; background-color: #c6005b;"></div>
                    <span class="small">Rendez-vous m√©dical</span>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded" style="width: 16px; height: 16px; background-color: #00c950;"></div>
                    <span class="small">√âv√©nement scolaire</span>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded" style="width: 16px; height: 16px; background-color: #1347e5;"></div>
                    <span class="small">Vacances</span>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded" style="width: 16px; height: 16px; background-color: #6a7282;"></div>
                    <span class="small">Autre</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card border rounded-4 h-100">
              <div class="card-body p-4">
                <h5 class="mb-1">Prochains √©v√©nements</h5>
                <p class="text-secondary small mb-4">Dans les 7 prochains jours</p>

                <div class="d-flex flex-column gap-3">
                  <% if @upcoming_events.any? %>
                    <% @upcoming_events.each do |event| %>
                      <div class="d-flex align-items-center gap-3">
                        <div class="rounded" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background-color: <%= event.event_color %>;">
                          <span style="font-size: 18px;"><%= event.event_icon %></span>
                        </div>
                        <div>
                          <div class="fw-medium"><%= event.title %></div>
                          <small class="text-secondary">
                            <%= l(event.start_date, format: :short) %>
                            <% if event.time.present? %>
                              - <%= event.time.strftime("%H:%M") %>
                            <% end %>
                          </small>
                        </div>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="text-center text-muted py-3">
                      <p class="mb-0">Aucun √©v√©nement √† venir dans les 7 prochains jours</p>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="week">
        <p class="text-center text-muted py-5">Vue semaine √† venir</p>
      </div>

      <div class="tab-pane fade" id="list">
        <p class="text-center text-muted py-5">Vue liste √† venir</p>
      </div>
    </div>
  </div>

  <!-- Modal Indisponibilit√© -->
  <div class="modal fade" id="unavailabilityModal" tabindex="-1" aria-labelledby="unavailabilityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-medium" id="unavailabilityModalLabel">Bloquer une p√©riode d'indisponibilit√©</h5>
            <p class="text-secondary small mb-0">Indiquez quand vous n'√™tes pas disponible pour les t√¢ches familiales</p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-3">
          <%= form_with(model: [@family, @family_event || FamilyEvent.new], local: true, html: { id: 'unavailabilityForm' }) do |f| %>
            <%= f.hidden_field :event_type, value: 'indisponibilite' %>

            <!-- Qui est indisponible -->
            <div class="mb-3">
              <%= f.label :assigned_to, "Qui est indisponible ?", class: "form-label fw-medium" %>
              <%= f.select :assigned_to, options_for_select(
                [['S√©lectionner un membre', '']] + @family_members.map { |member| [member.name, member.name] }
              ), {}, { class: "form-select", required: true } %>
            </div>

            <!-- Date de d√©but et Date de fin -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <%= f.label :start_date, "Date de d√©but", class: "form-label fw-medium" %>
                <%= f.date_field :start_date, class: "form-control", required: true %>
              </div>
              <div class="col-md-6">
                <%= f.label :end_date, "Date de fin", class: "form-label fw-medium" %>
                <%= f.date_field :end_date, class: "form-control" %>
              </div>
            </div>

            <!-- Raison (optionnel) -->
            <div class="mb-4">
              <%= f.label :description, "Raison (optionnel)", class: "form-label fw-medium" %>
              <%= f.text_field :description, class: "form-control", placeholder: "Ex: D√©placement professionnel" %>
            </div>

            <%= f.hidden_field :reminders_enabled, value: false %>

            <!-- Submit Button -->
            <%= f.submit "Bloquer cette p√©riode", class: "btn btn-dark w-100" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nouvel √âv√©nement -->
  <div class="modal fade" id="newEventModal" tabindex="-1" aria-labelledby="newEventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title fw-medium" id="newEventModalLabel">Cr√©er un nouvel √©v√©nement</h5>
            <p class="text-secondary small mb-0">Ajoutez un √©v√©nement au calendrier familial</p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-3">
          <%= form_with(model: [@family, @family_event || FamilyEvent.new], local: true, html: { id: 'newEventForm' }) do |f| %>
            <!-- Titre -->
            <div class="mb-3">
              <%= f.label :title, "Titre", class: "form-label fw-medium" %>
              <%= f.text_field :title, class: "form-control", placeholder: "Ex: Garde Lucas", required: true %>
            </div>

            <!-- Type d'√©v√©nement et Assign√© √† -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <%= f.label :event_type, "Type d'√©v√©nement", class: "form-label fw-medium" %>
                <%= f.select :event_type, options_for_select([
                  ['Choisir un type', ''],
                  ['Anniversaire', 'anniversaire'],
                  ['Garde d\'enfant', 'garde'],
                  ['Rendez-vous m√©dical', 'medical'],
                  ['√âv√©nement scolaire', 'scolaire'],
                  ['Vacances', 'vacances'],
                  ['Autre', 'autre']
                ]), {}, { class: "form-select", required: true } %>
              </div>
              <div class="col-md-6">
                <%= f.label :assigned_to, "Assign√© √†", class: "form-label fw-medium" %>
                <%= f.select :assigned_to, options_for_select(
                  [['Qui s\'en occupe?', '']] + @family_members.map { |member| [member.name, member.name] } + [['Toute la famille', 'Toute la famille']]
                ), {}, { class: "form-select" } %>
              </div>
            </div>

            <!-- Date et Heure -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <%= f.label :start_date, "Date", class: "form-label fw-medium" %>
                <%= f.date_field :start_date, class: "form-control", required: true %>
              </div>
              <div class="col-md-6">
                <%= f.label :time, "Heure", class: "form-label fw-medium" %>
                <%= f.time_field :time, class: "form-control" %>
              </div>
            </div>

            <!-- Lieu -->
            <div class="mb-3">
              <%= f.label :location, "Lieu", class: "form-label fw-medium" %>
              <%= f.text_field :location, class: "form-control", placeholder: "Ex: √âcole primaire" %>
            </div>

            <!-- Description -->
            <div class="mb-3">
              <%= f.label :description, "Description", class: "form-label fw-medium" %>
              <%= f.text_area :description, rows: 3, class: "form-control", placeholder: "D√©tails suppl√©mentaires..." %>
            </div>

            <!-- Activer les rappels -->
            <div class="form-check mb-3">
              <%= f.check_box :reminders_enabled, class: "form-check-input", checked: true %>
              <%= f.label :reminders_enabled, "Activer les rappels", class: "form-check-label fw-medium" %>
            </div>

            <!-- Partager avec d'autres familles -->
            <div class="mb-3">
              <label class="form-label fw-medium">Partager avec d'autres familles (optionnel)</label>
              <p class="text-secondary small mb-2">
                Vous pouvez partager cet √©v√©nement avec vos familles connect√©es depuis la page Connexions
              </p>
            </div>

            <!-- Submit Button -->
            <%= f.submit "Cr√©er l'√©v√©nement", class: "btn btn-dark w-100" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal D√©tails √âv√©nement -->
  <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0 pb-0">
          <div class="d-flex align-items-center">
            <div class="rounded-circle bg-primary-light d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
              <span class="text-primary fs-5" id="eventDetailsIcon">üïí</span>
            </div>
            <div>
              <h5 class="modal-title fw-medium mb-0" id="eventDetailsModalLabel">Garde Lucas - √âcole</h5>
              <span class="badge bg-light text-dark" id="eventDetailsTypeBadge">Garde d'enfant</span>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-3">
          <div class="d-flex flex-column gap-3 mb-4">
            <div class="d-flex align-items-start gap-2">
              <span class="text-secondary">üìÖ</span>
              <div>
                <div class="fw-medium">Date et heure</div>
                <small class="text-secondary" id="eventDetailsDate">mercredi 19 novembre 2025</small>
                <small class="text-secondary d-block" id="eventDetailsTime">16:30</small>
              </div>
            </div>
            <div class="d-flex align-items-start gap-2">
              <span class="text-secondary">üìç</span>
              <div>
                <div class="fw-medium">Lieu</div>
                <small class="text-secondary" id="eventDetailsLocation">√âcole primaire</small>
              </div>
            </div>
            <div class="d-flex align-items-start gap-2">
              <span class="text-secondary">‚óè</span>
              <div>
                <div class="fw-medium">Description</div>
                <small class="text-secondary" id="eventDetailsDescription">R√©cup√©rer Lucas √† l'√©cole</small>
              </div>
            </div>
            <div class="d-flex align-items-start gap-2">
              <span class="text-secondary">üßë‚Äçü§ù‚Äçüßë</span>
              <div>
                <div class="fw-medium">Assign√© √†</div>
                <span class="badge bg-light text-dark" id="eventDetailsAssigned">M Marc</span>
              </div>
            </div>
          </div>

          <div class="alert alert-info d-flex align-items-center gap-3 p-3 mb-3 mx-3" role="alert" id="eventDetailsReminder">
            <span class="fs-5">üîî</span>
            <small>Les rappels sont activ√©s pour cet √©v√©nement</small>
          </div>

          <div class="d-flex justify-content-between gap-2">
            <button type="button" class="btn btn-outline-secondary flex-grow-1" id="modifyEventBtn">Modifier</button>
            <button type="button" class="btn btn-danger flex-grow-1" id="deleteEventBtn">Supprimer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
  <script>
    let pageInitialized = false;

    function initializeFamilyEventsPage() {
      // Prevent double initialization
      if (pageInitialized) {
        console.log('Page already initialized, skipping');
        return;
      }
      pageInitialized = true;
      console.log('Initializing family events page');

      // Initialize Flatpickr for date and time fields
      flatpickr("#family_event_start_date", {
        locale: "fr",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: true
      });

      flatpickr("#family_event_time", {
        locale: "fr",
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        allowInput: true
      });

      // For unavailability modal
      flatpickr("#family_event_start_date_unavail", {
        locale: "fr",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: true
      });

      flatpickr("#family_event_end_date", {
        locale: "fr",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d/m/Y",
        allowInput: true
      });

      const eventDetailsModal = document.getElementById('eventDetailsModal');
      const newEventModal = document.getElementById('newEventModal');

      if (!eventDetailsModal || !newEventModal) {
        console.log('Modals not found, skipping initialization');
        return;
      }

      // Get action buttons from the event details modal
      const modifyEventBtn = document.getElementById('modifyEventBtn');
      const duplicateEventBtn = document.getElementById('duplicateEventBtn');
      const deleteEventBtn = document.getElementById('deleteEventBtn');

      let currentEventId = null;
      let currentEventData = null;

      // Function to update modal content from data attributes
      function updateModalContent(badge) {
        try {
          const eventData = {
            id: badge.dataset.eventId || '',
            title: badge.dataset.eventTitle || 'Sans titre',
            type: badge.dataset.eventType || 'Autre',
            typeValue: badge.dataset.eventTypeValue || '',
            date: badge.dataset.eventDate || '',
            startDate: badge.dataset.eventStartDate || '',
            time: badge.dataset.eventTime || '',
            timeValue: badge.dataset.eventTimeValue || '',
            location: badge.dataset.eventLocation || '',
            description: badge.dataset.eventDescription || '',
            assignedTo: badge.dataset.eventAssigned || '',
            icon: badge.dataset.eventIcon || 'üìå',
            badgeClass: badge.dataset.eventBadge || 'bg-secondary',
            reminders: badge.dataset.eventReminders === 'true'
          };

          console.log('Event data loaded:', eventData);

          currentEventId = eventData.id;
          currentEventData = eventData;

          // Update title
          const titleElement = document.getElementById('eventDetailsModalLabel');
          if (titleElement) titleElement.textContent = eventData.title;

          // Update icon
          const iconElement = document.getElementById('eventDetailsIcon');
          if (iconElement) iconElement.textContent = eventData.icon;

          // Update badge type
          const typeBadge = document.getElementById('eventDetailsTypeBadge');
          if (typeBadge) {
            typeBadge.className = `badge ${eventData.badgeClass} text-white`;
            typeBadge.textContent = eventData.type;
          }

          // Update date
          const dateElement = document.getElementById('eventDetailsDate');
          if (dateElement) dateElement.textContent = eventData.date || 'Non sp√©cifi√©';

          // Update time
          const timeElement = document.getElementById('eventDetailsTime');
          if (timeElement) timeElement.textContent = eventData.time || 'Non sp√©cifi√©';

          // Update location
          const locationElement = document.getElementById('eventDetailsLocation');
          if (locationElement) locationElement.textContent = eventData.location || 'Non sp√©cifi√©';

          // Update description
          const descriptionElement = document.getElementById('eventDetailsDescription');
          if (descriptionElement) descriptionElement.textContent = eventData.description || 'Aucune description';

          // Update assigned to
          const assignedElement = document.getElementById('eventDetailsAssigned');
          if (assignedElement) assignedElement.textContent = eventData.assignedTo || 'Non assign√©';

          // Show/hide reminder alert based on event data
          const reminderAlert = document.getElementById('eventDetailsReminder');
          if (reminderAlert) {
            reminderAlert.style.display = eventData.reminders ? 'flex' : 'none';
          }
        } catch (error) {
          console.error('Error updating modal content:', error);
        }
      }

      // Add click listeners using event delegation for dynamic content
      document.body.addEventListener('click', function(e) {
        const target = e.target.closest('[data-bs-toggle="modal"][data-bs-target="#eventDetailsModal"]');
        if (target) {
          e.preventDefault();
          updateModalContent(target);
        }
      });

      // Event listener for "Modifier" button
      if (modifyEventBtn) {
        modifyEventBtn.addEventListener('click', function() {
          if (currentEventId && currentEventData) {
            // Update the form action to use PATCH method for editing
            const form = document.getElementById('newEventForm');
            if (form) {
              form.action = `/families/<%= @family.id %>/family_events/${currentEventId}`;

              // Add hidden field for PATCH method if it doesn't exist
              let methodField = form.querySelector('input[name="_method"]');
              if (!methodField) {
                methodField = document.createElement('input');
                methodField.type = 'hidden';
                methodField.name = '_method';
                form.appendChild(methodField);
              }
              methodField.value = 'patch';

              // Fill the form with current event data using stored data
              const titleInput = form.querySelector('#family_event_title');
              const startDateInput = form.querySelector('#family_event_start_date');
              const timeInput = form.querySelector('#family_event_time');
              const locationInput = form.querySelector('#family_event_location');
              const descriptionInput = form.querySelector('#family_event_description');
              const assignedSelect = form.querySelector('#family_event_assigned_to');
              const typeSelect = form.querySelector('#family_event_event_type');
              const remindersCheckbox = form.querySelector('#family_event_reminders_enabled');

              if (titleInput) titleInput.value = currentEventData.title || '';
              if (startDateInput) startDateInput.value = currentEventData.startDate || '';
              if (timeInput) timeInput.value = currentEventData.timeValue || '';
              if (locationInput) locationInput.value = currentEventData.location || '';
              if (descriptionInput) descriptionInput.value = currentEventData.description || '';
              if (assignedSelect) assignedSelect.value = currentEventData.assignedTo || '';
              if (typeSelect) typeSelect.value = currentEventData.typeValue || '';
              if (remindersCheckbox) remindersCheckbox.checked = currentEventData.reminders;

              // Update modal title
              document.getElementById('newEventModalLabel').textContent = 'Modifier l\'√©v√©nement';

              // Update submit button text
              const submitBtn = form.querySelector('input[type="submit"]');
              if (submitBtn) submitBtn.value = 'Modifier l\'√©v√©nement';
            }
          }

          bootstrap.Modal.getInstance(eventDetailsModal).hide();
          const newEventBootstrapModal = new bootstrap.Modal(newEventModal);
          newEventBootstrapModal.show();
        });
      }

      // Event listener for "Dupliquer" button
      if (duplicateEventBtn) {
        duplicateEventBtn.addEventListener('click', function() {
          // TODO: Load event data into new form
          bootstrap.Modal.getInstance(eventDetailsModal).hide();
          const newEventBootstrapModal = new bootstrap.Modal(newEventModal);
          newEventBootstrapModal.show();
        });
      }

      // Event listener for "Supprimer" button
      if (deleteEventBtn) {
        deleteEventBtn.addEventListener('click', function() {
          console.log('Delete button clicked, currentEventId:', currentEventId);
          if (!currentEventId) {
            alert('Erreur: Aucun √©v√©nement s√©lectionn√©');
            return;
          }
          if (confirm('√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?')) {
            console.log('Deleting event with ID:', currentEventId);
            // Submit delete request via form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/families/<%= @family.id %>/family_events/${currentEventId}`;

            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'delete';

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'authenticity_token';
            csrfInput.value = document.querySelector('meta[name="csrf-token"]').content;

            form.appendChild(methodInput);
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
          }
        });
      }

      // Reset form when opening "New Event" modal (not from Modifier button)
      document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#newEventModal"]').forEach(button => {
        button.addEventListener('click', function() {
          const form = document.getElementById('newEventForm');
          if (form) {
            // Reset form to create mode
            form.action = `/families/<%= @family.id %>/family_events`;
            form.reset();

            // Remove PATCH method field if it exists
            const methodField = form.querySelector('input[name="_method"]');
            if (methodField) {
              methodField.remove();
            }

            // Reset modal title and button
            document.getElementById('newEventModalLabel').textContent = 'Cr√©er un nouvel √©v√©nement';
            const submitBtn = form.querySelector('input[type="submit"]');
            if (submitBtn) submitBtn.value = 'Cr√©er l\'√©v√©nement';
          }
        });
      });
    }

    // Reset initialization flag before page navigation
    document.addEventListener('turbo:before-visit', function() {
      console.log('Resetting pageInitialized flag');
      pageInitialized = false;
    });

    // Initialize on DOMContentLoaded (for regular page loads)
    document.addEventListener('DOMContentLoaded', initializeFamilyEventsPage);

    // Initialize on turbo:load (for Turbo navigation)
    document.addEventListener('turbo:load', function() {
      pageInitialized = false;
      initializeFamilyEventsPage();
    });

    // Also try turbo:render for frame updates
    document.addEventListener('turbo:render', function() {
      pageInitialized = false;
      initializeFamilyEventsPage();
    });
  </script>
 